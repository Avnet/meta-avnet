From 4b7e27a4fd4da175d20bb184416608ec314b7300 Mon Sep 17 00:00:00 2001
From: Thomas Nizan <tnizan@witekio.com>
Date: Sat, 31 Aug 2024 18:14:06 +0000
Subject: [PATCH] pci: controller: pcie-xilinx-dma-pl: enable clocks

Signed-off-by: Thomas Nizan <tnizan@witekio.com>
---
 drivers/pci/controller/pcie-xilinx-dma-pl.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/drivers/pci/controller/pcie-xilinx-dma-pl.c b/drivers/pci/controller/pcie-xilinx-dma-pl.c
index 96639fe47099..382922e6b5c6 100644
--- a/drivers/pci/controller/pcie-xilinx-dma-pl.c
+++ b/drivers/pci/controller/pcie-xilinx-dma-pl.c
@@ -4,6 +4,7 @@
  *
  * Copyright (C) 2023 Xilinx, Inc. All rights reserved.
  */
+#include <linux/clk.h>
 #include <linux/bitfield.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
@@ -707,10 +708,22 @@ static int xilinx_pl_dma_pcie_parse_dt(struct pl_dma_pcie *port,
 				       struct resource *bus_range)
 {
 	struct device *dev = port->dev;
+	struct clk *sys_clk;
+	struct clk *sys_clk_gt;
 	struct platform_device *pdev = to_platform_device(dev);
 	struct resource *res;
 	int err;
 
+	sys_clk = devm_clk_get_enabled(dev, "sys_clk");
+	if (IS_ERR(sys_clk))
+		return dev_err_probe(dev, PTR_ERR(sys_clk),
+				     "sys_clk request failed");
+
+	sys_clk_gt = devm_clk_get_enabled(dev, "sys_clk_gt");
+	if (IS_ERR(sys_clk_gt))
+		return dev_err_probe(dev, PTR_ERR(sys_clk_gt),
+				     "sys_clk_gt request failed");
+
 	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
 	if (!res) {
 		dev_err(dev, "Missing \"reg\" property\n");
